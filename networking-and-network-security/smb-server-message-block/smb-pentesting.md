---
description: Find and exploit SMB vulnerabilities
---

# SMB Pentesting

## Enumeration

### Using nmap

```awk
sudo nmap -sC -sV 10.10.170.245
```

A sample output can be like this:

{% code overflow="wrap" %}
```awk
Nmap scan report for 10.10.170.245
Host is up (0.19s latency).
Not shown: 997 closed tcp ports (reset)
PORT    STATE SERVICE     VERSION
22/tcp  open  ssh         OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 91df5c7c26226e9023a77dfa5ce1c252 (RSA)
|   256 8657f52af7869ccf02c1acbc34906b01 (ECDSA)
|_  256 81e3cce7c93c75d7fbe086a001417781 (ED25519)
139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp open  netbios-ssn Samba smbd 4.7.6-Ubuntu (workgroup: WORKGROUP)
Service Info: Host: POLOSMB; OS: Linux; CPE: cpe:/o:linux:linux_kernel

Host script results:
| smb2-security-mode: 
|   311: 
|_    Message signing enabled but not required
| smb-os-discovery: 
|   OS: Windows 6.1 (Samba 4.7.6-Ubuntu)
|   Computer name: polosmb
|   NetBIOS computer name: POLOSMB\x00
|   Domain name: \x00
|   FQDN: polosmb
|_  System time: 2023-05-09T11:07:11+00:00
|_clock-skew: mean: -5h29m43s, deviation: 0s, median: -5h29m43s
| nbstat: NetBIOS name: POLOSMB, NetBIOS user: <unknown>, NetBIOS MAC: 000000000000 (Xerox)
| Names:
|   POLOSMB<00>          Flags: <unique><active>
|   POLOSMB<03>          Flags: <unique><active>
|   POLOSMB<20>          Flags: <unique><active>
|   \x01\x02__MSBROWSE__\x02<01>  Flags: <group><active>
|   WORKGROUP<00>        Flags: <group><active>
|   WORKGROUP<1d>        Flags: <unique><active>
|_  WORKGROUP<1e>        Flags: <group><active>
| smb2-time: 
|   date: 2023-05-09T11:07:11
|_  start_date: N/A
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
```
{% endcode %}

### Using enum4linux

```bash
enum4linux -a 10.10.170.245
```

A sample output is as follows:

```bash
Starting enum4linux v0.9.1 ( http://labs.portcullis.co.uk/application/enum4linux/ ) on Tue May  9 22:24:42 2023

 =========================================( Target Information )=========================================

Target ........... 10.10.170.245
RID Range ........ 500-550,1000-1050
Username ......... ''
Password ......... ''
Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none


 ===========================( Enumerating Workgroup/Domain on 10.10.170.245 )===========================


[+] Got domain/workgroup name: WORKGROUP


 ===============================( Nbtstat Information for 10.10.170.245 )===============================

Looking up status of 10.10.170.245
        POLOSMB         <00> -         B <ACTIVE>  Workstation Service
        POLOSMB         <03> -         B <ACTIVE>  Messenger Service
        POLOSMB         <20> -         B <ACTIVE>  File Server Service
        ..__MSBROWSE__. <01> - <GROUP> B <ACTIVE>  Master Browser
        WORKGROUP       <00> - <GROUP> B <ACTIVE>  Domain/Workgroup Name
        WORKGROUP       <1d> -         B <ACTIVE>  Master Browser
        WORKGROUP       <1e> - <GROUP> B <ACTIVE>  Browser Service Elections

        MAC Address = 00-00-00-00-00-00

 ===================================( Session Check on 10.10.170.245 )===================================


[+] Server 10.10.170.245 allows sessions using username '', password ''


 ================================( Getting domain SID for 10.10.170.245 )================================

Domain Name: WORKGROUP
Domain Sid: (NULL SID)

[+] Can't determine if host is part of domain or part of a workgroup


 ==================================( OS information on 10.10.170.245 )==================================
                                                                                                                                                                                            
                                                                                                                                                                                            
[E] Can't get OS info with smbclient                                                                                                                                                        
                                                                                                                                                                                            
                                                                                                                                                                                            
[+] Got OS info for 10.10.170.245 from srvinfo:                                                                                                                                             
        POLOSMB        Wk Sv PrQ Unx NT SNT polosmb server (Samba, Ubuntu)                                                                                                                  
        platform_id     :       500
        os version      :       6.1
        server type     :       0x809a03


 =======================================( Users on 10.10.170.245 )=======================================
                                                                                                                                                                                            
Use of uninitialized value $users in print at ./enum4linux.pl line 972.                                                                                                                     
Use of uninitialized value $users in pattern match (m//) at ./enum4linux.pl line 975.

Use of uninitialized value $users in print at ./enum4linux.pl line 986.
Use of uninitialized value $users in pattern match (m//) at ./enum4linux.pl line 988.

 =================================( Share Enumeration on 10.10.170.245 )=================================
                                                                                                                                                                                            
                                                                                                                                                                                            
        Sharename       Type      Comment
        ---------       ----      -------
        netlogon        Disk      Network Logon Service
        profiles        Disk      Users profiles
        print$          Disk      Printer Drivers
        IPC$            IPC       IPC Service (polosmb server (Samba, Ubuntu))
Reconnecting with SMB1 for workgroup listing.

        Server               Comment
        ---------            -------

        Workgroup            Master
        ---------            -------
        WORKGROUP            POLOSMB

[+] Attempting to map shares on 10.10.170.245                                                                                                                                               
                                                                                                                                                                                            
                                                                                                                                                                                            
[E] Can't understand response:                                                                                                                                                              
                                                                                                                                                                                            
tree connect failed: NT_STATUS_BAD_NETWORK_NAME                                                                                                                                             
//10.10.170.245/netlogon        Mapping: N/A Listing: N/A Writing: N/A
//10.10.170.245/profiles        Mapping: OK Listing: OK Writing: N/A
//10.10.170.245/print$  Mapping: DENIED Listing: N/A Writing: N/A

[E] Can't understand response:                                                                                                                                                              
                                                                                                                                                                                            
NT_STATUS_OBJECT_NAME_NOT_FOUND listing \*                                                                                                                                                  
//10.10.170.245/IPC$    Mapping: N/A Listing: N/A Writing: N/A

 ===========================( Password Policy Information for 10.10.170.245 )===========================
                                                                                                                                                                                            
                                                                                                                                                                                            

[+] Attaching to 10.10.170.245 using a NULL share

[+] Trying protocol 139/SMB...

[+] Found domain(s):

        [+] POLOSMB
        [+] Builtin

[+] Password Info for Domain: POLOSMB

        [+] Minimum password length: 5
        [+] Password history length: None
        [+] Maximum password age: 37 days 6 hours 21 minutes 
        [+] Password Complexity Flags: 000000

                [+] Domain Refuse Password Change: 0
                [+] Domain Password Store Cleartext: 0
                [+] Domain Password Lockout Admins: 0
                [+] Domain Password No Clear Change: 0
                [+] Domain Password No Anon Change: 0
                [+] Domain Password Complex: 0

        [+] Minimum password age: None
        [+] Reset Account Lockout Counter: 30 minutes 
        [+] Locked Account Duration: 30 minutes 
        [+] Account Lockout Threshold: None
        [+] Forced Log off Time: 37 days 6 hours 21 minutes 



[+] Retieved partial password policy with rpcclient:                                                                                                                                        
                                                                                                                                                                                            
                                                                                                                                                                                            
Password Complexity: Disabled                                                                                                                                                               
Minimum Password Length: 5


 ======================================( Groups on 10.10.170.245 )======================================
                                                                                                                                                                                            
                                                                                                                                                                                            
[+] Getting builtin groups:                                                                                                                                                                 
                                                                                                                                                                                            
                                                                                                                                                                                            
[+]  Getting builtin group memberships:                                                                                                                                                     
                                                                                                                                                                                            
                                                                                                                                                                                            
[+]  Getting local groups:                                                                                                                                                                  
                                                                                                                                                                                            
                                                                                                                                                                                            
[+]  Getting local group memberships:                                                                                                                                                       
                                                                                                                                                                                            
                                                                                                                                                                                            
[+]  Getting domain groups:                                                                                                                                                                 
                                                                                                                                                                                            
                                                                                                                                                                                            
[+]  Getting domain group memberships:                                                                                                                                                      
                                                                                                                                                                                            
                                                                                                                                                                                            
 ==================( Users on 10.10.170.245 via RID cycling (RIDS: 500-550,1000-1050) )==================
                                                                                                                                                                                            
                                                                                                                                                                                            
[I] Found new SID:                                                                                                                                                                          
S-1-22-1                                                                                                                                                                                    

[I] Found new SID:                                                                                                                                                                          
S-1-5-32                                                                                                                                                                                    

[I] Found new SID:                                                                                                                                                                          
S-1-5-32                                                                                                                                                                                    

[I] Found new SID:                                                                                                                                                                          
S-1-5-32                                                                                                                                                                                    

[I] Found new SID:                                                                                                                                                                          
S-1-5-32                                                                                                                                                                                    

[+] Enumerating users using SID S-1-5-32 and logon username '', password ''                                                                                                                 
                                                                                                                                                                                            
S-1-5-32-544 BUILTIN\Administrators (Local Group)                                                                                                                                           
S-1-5-32-545 BUILTIN\Users (Local Group)
S-1-5-32-546 BUILTIN\Guests (Local Group)
S-1-5-32-547 BUILTIN\Power Users (Local Group)
S-1-5-32-548 BUILTIN\Account Operators (Local Group)
S-1-5-32-549 BUILTIN\Server Operators (Local Group)
S-1-5-32-550 BUILTIN\Print Operators (Local Group)

[+] Enumerating users using SID S-1-22-1 and logon username '', password ''                                                                                                                 
                                                                                                                                                                                            
S-1-22-1-1000 Unix User\cactus (Local User)                                                                                                                                                 

[+] Enumerating users using SID S-1-5-21-434125608-3964652802-3194254534 and logon username '', password ''                                                                                 
                                                                                                                                                                                            
S-1-5-21-434125608-3964652802-3194254534-501 POLOSMB\nobody (Local User)                                                                                                                    
S-1-5-21-434125608-3964652802-3194254534-513 POLOSMB\None (Domain Group)

 ===============================( Getting printer info for 10.10.170.245 )===============================
                                                                                                                                                                                            
No printers returned.                                                                                                                                                                       


enum4linux complete on Tue May  9 22:41:39 2023
```

## Exploitation

The smbclient utility and impacket library are two good utilities to exploit SMB vulnerability.

### Using smbclient

Let's say we want to access an SMB share called "secret" as user "suit" on a machine with the IP 10.10.10.2 on the default port

```
smbclient //10.10.10.2/secret -U "suit" -p 445
```

### Anonymous login with empty passwords

#### In general shares

```
smbclient //10.10.96.221/profiles -U ''
smbclient //10.10.96.221/profiles -U 'Anonymous'
```

### Navigating through SMB

#### List all available files

```
smb: \> ls
smb: \> dir
```

#### Get multiple or single files (mget command)

```
smb: \.ssh\> mget id_rsa*
```
